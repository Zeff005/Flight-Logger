<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INVA Receipt Generator</title>
<style>
  * { box-sizing: border-box; }
  
  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #1a1a1a;
    min-height: 100vh;
    color: #e0e0e0;
    line-height: 1.6;
  }
  
  .container { 
    max-width: 1200px; 
    margin: 0 auto; 
    background: #2d2d2d;
    border-radius: 16px; 
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    border: 2px solid #FFCB83;
  }
  
  .header {
    background: linear-gradient(135deg, #7B0F1D 0%, #5a0012 100%);
    color: #FFFFFF;
    padding: 30px;
    text-align: center;
    border-bottom: 4px solid #FFCB83;
  }
  
  .header h1 { 
    margin: 0 0 8px; 
    font-size: 32px;
    font-weight: 700;
    color: #FFFFFF;
  }
  
  .header .subtitle { 
    color: #FFCB83;
    font-size: 15px;
    font-weight: 500;
  }
  
  .content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
  }
  
  .form-section {
    padding: 30px;
    background: rgba(0, 0, 0, 0.3);
    border-right: 2px solid #FFCB83;
  }
  
  .receipt-section {
    padding: 30px;
    background: #2d2d2d;
  }
  
  .section-title {
    font-size: 18px;
    font-weight: 700;
    margin: 0 0 20px;
    color: #FFCB83;
    padding-bottom: 10px;
    border-bottom: 2px solid #FFCB83;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .section-title::before {
    content: '☁';
    font-size: 20px;
  }
  
  .form-group { 
    margin-bottom: 18px; 
  }
  
  label { 
    display: block; 
    font-size: 14px; 
    margin-bottom: 6px; 
    font-weight: 600;
    color: #e0e0e0;
  }
  
  input, select, textarea { 
    width: 100%; 
    padding: 12px; 
    border-radius: 8px; 
    border: 1px solid rgba(255, 203, 131, 0.3);
    font-size: 14px;
    transition: all 0.3s ease;
    background: rgba(255, 203, 131, 0.05);
    color: #e0e0e0;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #FFCB83;
    box-shadow: 0 0 0 3px rgba(255, 203, 131, 0.1);
    background: rgba(255, 203, 131, 0.08);
  }
  
  input::placeholder {
    color: rgba(224, 224, 224, 0.5);
  }
  
  select {
    cursor: pointer;
  }
  
  select option {
    background: #2d2d2d;
    color: #e0e0e0;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  .controls { 
    display: flex; 
    gap: 12px; 
    margin-top: 24px; 
  }
  
  button { 
    flex: 1;
    padding: 14px 20px; 
    border-radius: 8px; 
    border: 2px solid #FFCB83;
    background: linear-gradient(135deg, #7B0F1D 0%, #5a0012 100%);
    color: #FFFFFF; 
    cursor: pointer; 
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(123, 15, 29, 0.4);
  }
  
  button:hover { 
    background: #FFCB83;
    color: #2d2d2d;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 203, 131, 0.4);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  button.secondary {
    background: rgba(255, 203, 131, 0.1);
    border-color: #FFCB83;
    color: #FFCB83;
  }
  
  button.secondary:hover {
    background: #FFCB83;
    color: #2d2d2d;
  }
  
  .receipt { 
    background: rgba(255, 203, 131, 0.05);
    border: 2px solid #FFCB83;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .receipt-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #FFCB83;
  }
  
  .receipt-header h2 {
    margin: 0 0 8px;
    font-size: 24px;
    color: #FFCB83;
    font-weight: 700;
  }
  
  .receipt-meta {
    font-size: 13px;
    color: #d0d0d0;
    line-height: 1.6;
  }
  
  .receipt-meta strong {
    color: #FFCB83;
  }
  
  .receipt-logo {
    text-align: right;
    font-weight: 700;
    color: #FFCB83;
    font-size: 14px;
    line-height: 1.4;
  }
  
  table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-bottom: 16px;
  }
  
  td, th { 
    padding: 10px 12px; 
    border-bottom: 1px solid rgba(255, 203, 131, 0.2);
    text-align: left;
    font-size: 14px;
  }
  
  td:first-child {
    color: #d0d0d0;
    font-weight: 500;
  }
  
  td:last-child {
    color: #FFCB83;
    font-weight: 600;
  }
  
  tbody tr:hover {
    background: rgba(255, 203, 131, 0.05);
  }
  
  .totals-table td {
    padding: 12px;
    font-size: 15px;
  }
  
  .totals-table tr:nth-last-child(2) td {
    border-top: 2px solid #FFCB83;
    padding: 14px 12px;
    font-size: 16px;
    font-weight: 700;
    color: #FFCB83;
    border-bottom: 1px solid rgba(255, 203, 131, 0.3);
  }
  
  .totals-table tr:last-child td {
    padding: 14px 12px;
    font-size: 16px;
    font-weight: 700;
    color: #FFCB83;
    border-bottom: 2px solid #FFCB83;
  }
  
  .right { 
    text-align: right; 
  }
  
  .notes { 
    margin-top: 20px; 
    padding: 12px;
    background: rgba(123, 15, 29, 0.2);
    border-left: 4px solid #7B0F1D;
    border-radius: 4px;
    font-size: 12px;
    color: #d0d0d0;
    line-height: 1.5;
  }
  
  .notes strong {
    color: #FFCB83;
  }
  
  .alert {
    padding: 14px 18px;
    border-radius: 8px;
    margin-top: 16px;
    font-size: 14px;
    font-weight: 500;
    display: none;
    animation: slideIn 0.3s ease;
  }
  
  .alert.success {
    background: rgba(34, 197, 94, 0.15);
    color: #4ade80;
    border: 1px solid rgba(74, 222, 128, 0.3);
  }
  
  .alert.error {
    background: rgba(239, 68, 68, 0.15);
    color: #f87171;
    border: 1px solid rgba(248, 113, 113, 0.3);
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .helper-text {
    font-size: 12px;
    color: rgba(224, 224, 224, 0.6);
    margin-top: 6px;
  }
  
  /* Mobile responsiveness */
  @media (max-width: 968px) {
    body {
      padding: 10px;
    }
    
    .content {
      grid-template-columns: 1fr;
    }
    
    .form-section {
      border-right: none;
      border-bottom: 2px solid #FFCB83;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .header h1 {
      font-size: 24px;
    }
    
    .header .subtitle {
      font-size: 13px;
    }
    
    .container {
      border-radius: 8px;
    }
    
    .form-section, .receipt-section {
      padding: 20px;
    }
    
    button {
      padding: 14px 18px;
      font-size: 14px;
      min-height: 48px;
    }
    
    input, select, textarea {
      padding: 14px 12px;
      font-size: 16px;
      min-height: 48px;
    }
    
    .section-title {
      font-size: 16px;
    }
    
    .receipt {
      padding: 16px;
    }
    
    .receipt-header {
      flex-direction: column;
      gap: 12px;
    }
    
    .receipt-header h2 {
      font-size: 20px;
    }
    
    .receipt-logo {
      text-align: left;
    }
    
    table {
      font-size: 13px;
    }
    
    td, th {
      padding: 8px;
      font-size: 13px;
    }
    
    .totals-table td {
      font-size: 14px;
    }
    
    .totals-table tr:nth-last-child(2) td,
    .totals-table tr:last-child td {
      font-size: 15px;
    }
    
    .controls {
      flex-direction: column;
      gap: 10px;
    }
    
    button {
      width: 100%;
    }
  }
  
  @media (max-width: 480px) {
    body {
      padding: 5px;
    }
    
    .header {
      padding: 20px 15px;
    }
    
    .header h1 {
      font-size: 20px;
    }
    
    .header .subtitle {
      font-size: 12px;
    }
    
    .form-section, .receipt-section {
      padding: 15px;
    }
    
    .section-title {
      font-size: 15px;
    }
    
    .receipt {
      padding: 12px;
    }
    
    input, select, textarea {
      font-size: 16px;
    }
    
    label {
      font-size: 13px;
    }
    
    .helper-text {
      font-size: 11px;
    }
  }
  
  @media (min-width: 969px) {
    .content {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  @media print {
    body {
      background: #fff;
      margin: 0;
      padding: 20px;
      color: #000;
    }
    
    .container {
      box-shadow: none;
      border-radius: 0;
      max-width: 100%;
      border: none;
      background: #fff;
    }
    
    .header, .form-section, .controls, button, .alert {
      display: none !important;
    }
    
    .content {
      display: block;
    }
    
    .receipt-section {
      padding: 0;
      background: #fff;
    }
    
    .receipt {
      border: 2px solid #000;
      box-shadow: none;
      background: #fff;
    }
    
    .receipt-header h2,
    .receipt-logo,
    .section-title,
    td:last-child,
    .receipt-meta strong {
      color: #000 !important;
    }
    
    td:first-child {
      color: #333 !important;
    }
    
    .notes {
      background: #f5f5f5;
      border-left-color: #333;
      color: #000;
    }
    
    .notes strong {
      color: #000;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>✈️ INVA Receipt Generator</h1>
    <div class="subtitle">Professional Flight Earnings & Receipt Management System</div>
  </div>

  <div class="content">
    <!-- Form Section -->
    <div class="form-section">
      <h3 class="section-title">Flight Details</h3>
      
      <div class="form-group">
        <label>Pilot Name *</label>
        <input type="text" id="pilot" placeholder="Enter pilot name">
      </div>

      <div class="form-group">
        <label>Rank *</label>
        <select id="rank">
          <option value="">-- Select Rank --</option>
          <option value="Cadet / Trainee" data-rate="1333" data-maxbonus="750">Cadet / Trainee</option>
          <option value="Junior FO" data-rate="1800" data-maxbonus="1250">Junior FO</option>
          <option value="First Officer" data-rate="2600" data-maxbonus="2250">First Officer</option>
          <option value="Senior FO" data-rate="3100" data-maxbonus="2750">Senior FO</option>
          <option value="Captain" data-rate="3500" data-maxbonus="3250">Captain</option>
          <option value="Senior Captain" data-rate="3800" data-maxbonus="3750">Senior Captain</option>
          <option value="Chief Pilot" data-rate="4000" data-maxbonus="4250">Chief Pilot</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>INVA Callsign *</label>
          <input type="text" id="callsign" placeholder="e.g. 123" maxlength="3" pattern="\d{3}">
          <div class="helper-text">3 digits only</div>
        </div>

        <div class="form-group">
          <label>Flight Number *</label>
          <input type="text" id="flightnum" placeholder="e.g. IX998">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Departure ICAO *</label>
          <input type="text" id="depicao" placeholder="e.g. VIDP" maxlength="4">
        </div>

        <div class="form-group">
          <label>Arrival ICAO *</label>
          <input type="text" id="arricao" placeholder="e.g. VABB" maxlength="4">
        </div>
      </div>

      <div class="form-group">
        <label>Aircraft *</label>
        <select id="aircraft">
          <option value="">-- Select Aircraft --</option>
          <option value="A319" data-mult="1.00">A319 — ×1.00</option>
          <option value="A320" data-mult="1.00">A320 — ×1.00</option>
          <option value="B738" data-mult="1.00">B738 — ×1.00</option>
          <option value="B737 MAX" data-mult="1.05">B737 MAX — ×1.05</option>
          <option value="A321" data-mult="1.05">A321 — ×1.05</option>
          <option value="B788" data-mult="1.15">B788 — ×1.15</option>
          <option value="B789" data-mult="1.15">B789 — ×1.15</option>
          <option value="B77W" data-mult="1.25">B77W — ×1.25</option>
          <option value="B77L" data-mult="1.25">B77L — ×1.25</option>
          <option value="B744" data-mult="1.50">B744 — ×1.50</option>
          <option value="A350" data-mult="1.35">A350 — ×1.35</option>
        </select>
      </div>

      <div class="form-group">
        <label>Flight Time *</label>
        <input type="text" id="ftime" placeholder="e.g. 03:34 or 3.5667">
        <div class="helper-text">Format: hh:mm or decimal hours</div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Passengers *</label>
          <input type="number" id="passengers" placeholder="e.g. 150" min="0" step="1">
        </div>

        <div class="form-group">
          <label>Cargo Weight (kg) *</label>
          <input type="text" id="cargo" placeholder="e.g. 3000" inputmode="numeric">
        </div>
      </div>

      <div class="form-group">
        <label>Fuel Used (kg) *</label>
        <input type="number" id="fuelused" placeholder="e.g. 20000" min="0" step="1">
      </div>

      <div class="form-group">
        <label>XP Earned *</label>
        <input type="text" id="xpearned" placeholder="e.g. 123456" maxlength="6" inputmode="numeric">
        <div class="helper-text">6 digits only</div>
      </div>

      <div class="controls">
        <button type="button" id="sendBtn">📤 Submit Flight</button>
        <button type="button" id="printBtn" class="secondary">🖨️ Print / PDF</button>
      </div>

      <div id="alertBox" class="alert"></div>
    </div>

    <!-- Receipt Section -->
    <div class="receipt-section">
      <h3 class="section-title">Live Receipt Preview</h3>
      
      <div class="receipt" id="receipt">
        <div class="receipt-header">
          <div>
            <h2>INVA RECEIPT</h2>
            <div class="receipt-meta">
              <div>Receipt #: <strong id="rno">VA-0001</strong></div>
              <div>Date: <strong id="rdate">-</strong></div>
            </div>
          </div>
          <div class="receipt-logo">
            INVA<br>Career Mode
          </div>
        </div>

        <table>
          <tbody>
            <tr><td>Pilot</td><td id="rpilot">-</td></tr>
            <tr><td>Rank</td><td id="rrank">-</td></tr>
            <tr><td>INVA Callsign</td><td id="rcallsign">-</td></tr>
            <tr><td>Flight Number</td><td id="rflightnum">-</td></tr>
            <tr><td>Route</td><td id="rroute">-</td></tr>
            <tr><td>Aircraft</td><td id="rair">-</td></tr>
            <tr><td>Flight Time</td><td id="rftime">-</td></tr>
            <tr><td>Base Rate</td><td id="rbase">₹0.00</td></tr>
            <tr><td>Multiplier</td><td id="rmult">×1.00</td></tr>
            <tr><td>XP Earned</td><td id="rxp">0</td></tr>
          </tbody>
        </table>

        <table class="totals-table">
          <tbody>
            <tr><td>Flight Earnings</td><td class="right" id="rearn">₹0.00</td></tr>
            <tr><td>Payload Bonus</td><td class="right" id="rbonus">₹0.00</td></tr>
            <tr><td>Deductions (15% Tax)</td><td class="right" id="rded">₹0.00</td></tr>
            <tr><td>Final Earnings (INR)</td><td class="right" id="grand">₹0.00</td></tr>
            <tr><td>Final Earnings (USD)</td><td class="right" id="rusd">$0.00</td></tr>
          </tbody>
        </table>

        <div class="notes">
          <strong>Note:</strong> This receipt is generated for INVA virtual airline use only. 
          All calculations include base rate, aircraft multiplier, payload bonus (based on load factor 
          and efficiency), and applicable deductions. Do not use for fraudulent real-world claims.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ========================================
// CONFIGURATION - REPLACE WITH YOUR VALUES
// ========================================

const DISCORD_WEBHOOK_URL = "https://discordapp.com/api/webhooks/1424101218283946128/GuS7iqwSLSZyRR6yYgqu2yjjn3Y4nvEq6CG0rb_yT_lZxEdQaRGjGcSZvCDOtWf2GOHN";

const GOOGLE_SHEET_CONFIG = {
  scriptUrl: "https://script.google.com/macros/s/AKfycbwhH81uxuCUfuh2ZPAe-bDSokW9FORC7qSU6ILB7gLRJX504MHhBNZiSdqngXhhaMnX/exec",
  token: ""
};

// ========================================
// UTILITY FUNCTIONS
// ========================================

function asNumber(x) {
  const n = Number(String(x).replace(/[^0-9.-]/g, ''));
  return isNaN(n) ? 0 : n;
}

function parseTimeToHours(s) {
  if (!s) return 0;
  s = String(s).trim();
  
  if (s.includes(':')) {
    const parts = s.split(':').map(Number);
    return (parts[0] || 0) + (parts[1] || 0) / 60 + (parts[2] || 0) / 3600;
  }
  
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}

function formatTimeDisplay(s) {
  if (!s) return '-';
  return s;
}

function currency(n) {
  return '₹' + Number(Math.round(n * 100) / 100).toFixed(2);
}

function round2(n) {
  return Math.round(n * 100) / 100;
}

function showAlert(message, type) {
  const alertBox = document.getElementById('alertBox');
  alertBox.textContent = message;
  alertBox.className = `alert ${type}`;
  alertBox.style.display = 'block';
  
  setTimeout(() => {
    alertBox.style.display = 'none';
  }, 5000);
}

let usdConversionTimeout;
function debounce(func, delay) {
  return function(...args) {
    clearTimeout(usdConversionTimeout);
    usdConversionTimeout = setTimeout(() => func.apply(this, args), delay);
  };
}

// ========================================
// RECEIPT CALCULATION & UPDATE
// ========================================

function updateReceipt() {
  const pilot = document.getElementById('pilot').value || '';
  const rankEl = document.getElementById('rank');
  const rank = rankEl.value;
  const selRank = rankEl.options[rankEl.selectedIndex];
  const baseRate = asNumber(selRank.getAttribute('data-rate'));
  const maxBonus = asNumber(selRank.getAttribute('data-maxbonus'));

  const aircraftEl = document.getElementById('aircraft');
  const aircraft = aircraftEl.value;
  const mult = Number(aircraftEl.options[aircraftEl.selectedIndex].getAttribute('data-mult') || 1);

  const ftime = document.getElementById('ftime').value;
  let hrs = parseTimeToHours(ftime);
  hrs = round2(hrs);

  const callsign = document.getElementById('callsign').value || '';
  const flightnum = document.getElementById('flightnum').value || '';
  const depicao = document.getElementById('depicao').value.toUpperCase() || '';
  const arricao = document.getElementById('arricao').value.toUpperCase() || '';

  const passengers = asNumber(document.getElementById('passengers').value);
  const cargo = asNumber(document.getElementById('cargo').value);
  const fuelused = asNumber(document.getElementById('fuelused').value);
  const xpearned = document.getElementById('xpearned').value || '0';

  const earnings = round2(hrs * baseRate * mult);

  const seatCapMap = {
    'A319': 136, 'A320': 175, 'B738': 189, 'B737 MAX': 189,
    'A321': 239, 'B788': 364, 'B789': 364, 'B77W': 503,
    'B77L': 441, 'B744': 416, 'A350': 440
  };
  
  const capacity = seatCapMap[aircraft] || 0;
  const loadFactor = capacity ? Math.min(passengers / capacity, 1) : 0;
  const payload = passengers * 95 + cargo;
  const ppp = fuelused ? payload / fuelused : 0;
  const pppRef = 1;
  const efficiencyRatio = ppp / pppRef;
  let score = (loadFactor + efficiencyRatio) / 2;
  if (score > 1) score = 1;
  
  const payloadBonus = round2(Math.min(score * maxBonus, maxBonus));
  const deduction = round2(earnings * 0.15);
  const grandTotal = round2(earnings + payloadBonus - deduction);

  const today = new Date();
  const dateStr = today.getFullYear() + '-' + 
                  String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                  String(today.getDate()).padStart(2, '0');
  
  document.getElementById('rdate').textContent = dateStr;
  document.getElementById('rno').textContent = 'VA-' + (Math.floor(Math.random() * 9000) + 1000);
  document.getElementById('rpilot').textContent = pilot || '-';
  document.getElementById('rrank').textContent = rank || '-';
  document.getElementById('rcallsign').textContent = callsign ? 'INVA' + callsign : '-';
  document.getElementById('rflightnum').textContent = flightnum || '-';
  document.getElementById('rroute').textContent = depicao && arricao ? `${depicao} → ${arricao}` : '-';
  document.getElementById('rair').textContent = aircraft || '-';
  
  const displayTime = ftime;
  document.getElementById('rftime').textContent = ftime ? `${displayTime} (${hrs.toFixed(2)}h)` : '-';
  
  document.getElementById('rbase').textContent = currency(baseRate);
  document.getElementById('rmult').textContent = '×' + mult.toFixed(2);
  document.getElementById('rxp').textContent = xpearned;
  document.getElementById('rearn').textContent = currency(earnings);
  document.getElementById('rbonus').textContent = currency(payloadBonus);
  document.getElementById('rded').textContent = currency(deduction);
  document.getElementById('grand').textContent = currency(grandTotal);

  fetchUSDConversion(grandTotal);
}

const fetchUSDConversion = debounce(function(grandTotal) {
  if (grandTotal === 0) {
    document.getElementById('rusd').textContent = '$0.00';
    return;
  }
  
  fetch("https://api.frankfurter.app/latest?from=INR&to=USD")
    .then(res => res.json())
    .then(data => {
      const rate = data.rates.USD || 0;
      document.getElementById('rusd').textContent = '$' + (grandTotal * rate).toFixed(2);
    })
    .catch(() => {
      document.getElementById('rusd').textContent = '$0.00';
    });
}, 500);

// ========================================
// VALIDATION
// ========================================

function validateForm() {
  const required = ['pilot', 'rank', 'callsign', 'flightnum', 'depicao', 'arricao', 'aircraft', 'ftime', 'passengers', 'cargo', 'fuelused', 'xpearned'];
  
  for (const id of required) {
    const el = document.getElementById(id);
    if (!el.value || el.value.trim() === '') {
      showAlert(`Please fill in the ${el.previousElementSibling.textContent.replace(' *', '')} field`, 'error');
      el.focus();
      return false;
    }
  }
  
  return true;
}

// ========================================
// SEND TO DISCORD
// ========================================

async function sendToDiscord(flightData) {
  if (DISCORD_WEBHOOK_URL === "YOUR_DISCORD_WEBHOOK_URL_HERE") {
    console.warn("Discord webhook URL not configured");
    return { success: false, error: "Discord webhook not configured" };
  }

  const embed = {
    title: "✈️ New Flight Submission",
    color: 0x7B0F1D,
    fields: [
      { name: "👨‍✈️ Pilot", value: flightData.pilot, inline: true },
      { name: "🎖️ Rank", value: flightData.rank, inline: true },
      { name: "📞 Callsign", value: `INVA${flightData.callsign}`, inline: true },
      { name: "🔢 Flight Number", value: flightData.flightNumber, inline: true },
      { name: "🛫 Departure", value: flightData.departure, inline: true },
      { name: "🛬 Arrival", value: flightData.arrival, inline: true },
      { name: "✈️ Aircraft", value: flightData.aircraft, inline: true },
      { name: "⏱️ Flight Time", value: flightData.flightTime, inline: true },
      { name: "👥 Passengers", value: flightData.passengers.toString(), inline: true },
      { name: "📦 Cargo", value: `${flightData.cargo} kg`, inline: true },
      { name: "⛽ Fuel Used", value: `${flightData.fuelUsed} kg`, inline: true },
      { name: "⭐ XP Earned", value: flightData.xpEarned, inline: true },
      { name: "💰 Grand Total", value: flightData.grandTotal, inline: true }
    ],
    footer: {
      text: "INVA Flight Management System"
    },
    timestamp: new Date().toISOString()
  };

  try {
    const response = await fetch(DISCORD_WEBHOOK_URL, {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: "INVA Flight Tracker",
        embeds: [embed]
      })
    });

    if (response.ok) {
      return { success: true };
    } else {
      return { success: false, error: "Discord API error" };
    }
  } catch (error) {
    console.error("Discord error:", error);
    return { success: false, error: error.message };
  }
}

// ========================================
// SEND TO GOOGLE SHEETS
// ========================================

async function sendToGoogleSheets(flightData) {
  if (GOOGLE_SHEET_CONFIG.scriptUrl === "YOUR_NEW_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") {
    console.warn("Google Sheets script URL not configured - skipping Google Sheets");
    return { success: false, error: "Google Sheets not configured" };
  }

  const sheetData = {
    token: GOOGLE_SHEET_CONFIG.token,
    date: flightData.date,
    receipt_no: flightData.receiptNo,
    pilot: flightData.pilot,
    rank: flightData.rank,
    flight_no: flightData.flightNumber,
    dep: flightData.departure,
    arr: flightData.arrival,
    aircraft: flightData.aircraft,
    flight_time_h: parseTimeToHours(flightData.flightTime),
    flight_time_m: parseTimeToHours(flightData.flightTime) * 60,
    passengers: parseInt(flightData.passengers) || 0,
    cargo_kg: parseInt(flightData.cargo) || 0,
    fuel_total_kg: parseInt(flightData.fuelUsed) || 0,
    fuel_used_kg: parseInt(flightData.fuelUsed) || 0,
    base_rate_inr_per_hr: parseFloat(flightData.baseRate.replace(/[^0-9.-]/g, '')) || 0,
    multiplier: parseFloat(flightData.multiplier.replace(/[^0-9.-]/g, '')) || 0,
    flight_earnings_inr: parseFloat(flightData.earnings.replace(/[^0-9.-]/g, '')) || 0,
    payload_bonus_inr: parseFloat(flightData.payloadBonus.replace(/[^0-9.-]/g, '')) || 0,
    deductions_inr: parseFloat(flightData.deductions.replace(/[^0-9.-]/g, '')) || 0,
    grand_total_inr: parseFloat(flightData.grandTotal.replace(/[^0-9.-]/g, '')) || 0,
    usd_est: parseFloat(flightData.grandTotalUSD.replace(/[^0-9.-]/g, '')) || 0,
    xp_earned: parseInt(flightData.xpEarned) || 0,
    notes: "",
    share_url: ""
  };

  try {
    const response = await fetch(GOOGLE_SHEET_CONFIG.scriptUrl, {
      method: "POST",
      mode: "no-cors",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(sheetData)
    });

    console.log("Google Sheets: Data sent successfully");
    return { success: true };
  } catch (error) {
    console.error("Google Sheets error:", error);
    return { success: false, error: error.message };
  }
}

// ========================================
// SUBMIT FLIGHT
// ========================================

async function submitFlight() {
  if (!validateForm()) {
    return;
  }

  updateReceipt();

  const flightData = {
    date: document.getElementById('rdate').textContent,
    receiptNo: document.getElementById('rno').textContent,
    pilot: document.getElementById('pilot').value,
    rank: document.getElementById('rank').value,
    callsign: document.getElementById('callsign').value,
    flightNumber: document.getElementById('flightnum').value,
    departure: document.getElementById('depicao').value.toUpperCase(),
    arrival: document.getElementById('arricao').value.toUpperCase(),
    aircraft: document.getElementById('aircraft').value,
    flightTime: document.getElementById('ftime').value,
    passengers: document.getElementById('passengers').value,
    cargo: document.getElementById('cargo').value,
    fuelUsed: document.getElementById('fuelused').value,
    xpEarned: document.getElementById('xpearned').value,
    baseRate: document.getElementById('rbase').textContent,
    multiplier: document.getElementById('rmult').textContent,
    earnings: document.getElementById('rearn').textContent,
    payloadBonus: document.getElementById('rbonus').textContent,
    deductions: document.getElementById('rded').textContent,
    grandTotal: document.getElementById('grand').textContent,
    grandTotalUSD: document.getElementById('rusd').textContent
  };

  const sendBtn = document.getElementById('sendBtn');
  sendBtn.disabled = true;
  sendBtn.textContent = '⏳ Submitting...';

  const [discordResult, sheetsResult] = await Promise.all([
    sendToDiscord(flightData),
    sendToGoogleSheets(flightData)
  ]);

  sendBtn.disabled = false;
  sendBtn.textContent = '📤 Submit Flight';

  if (discordResult.success || sheetsResult.success) {
    showAlert('✅ Flight submitted successfully!', 'success');
  } else {
    showAlert('⚠️ Submission completed with warnings. Check console for details.', 'error');
  }
}

// ========================================
// EVENT LISTENERS
// ========================================

document.getElementById('ftime').addEventListener('input', function(e) {
  updateReceipt();
});

document.getElementById('cargo').addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, '');
  updateReceipt();
});

document.getElementById('xpearned').addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);
  updateReceipt();
});

document.getElementById('callsign').addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, '');
  updateReceipt();
});

document.getElementById('depicao').addEventListener('input', function(e) {
  this.value = this.value.toUpperCase();
  updateReceipt();
});

document.getElementById('arricao').addEventListener('input', function(e) {
  this.value = this.value.toUpperCase();
  updateReceipt();
});

document.getElementById('sendBtn').addEventListener('click', submitFlight);

document.getElementById('printBtn').addEventListener('click', function() {
  updateReceipt();
  setTimeout(() => window.print(), 150);
});

const fieldsToWatch = ['pilot', 'rank', 'aircraft', 'flightnum', 'passengers', 'fuelused'];

fieldsToWatch.forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('input', updateReceipt);
    el.addEventListener('change', updateReceipt);
  }
});

updateReceipt();
</script>

</body>
</html>
